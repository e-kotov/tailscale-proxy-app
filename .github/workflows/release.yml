name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Release Linux & Windows
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/goreleaser/goreleaser-cross:v1.24
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fix git safe directory in container
        run: git config --global --add safe.directory /__w/${{ github.event.repository.name }}/${{ github.event.repository.name }}

      - name: Install X11 and OpenGL development dependencies
        run: |
          dpkg --add-architecture arm64
          sed -i 's/\[arch=amd64\]/[arch=amd64,arm64]/g' /etc/apt/sources.list
          apt-get update
          apt-get install -y pkg-config libx11-dev libgl-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev libxxf86vm-dev
          apt-get install -y libx11-dev:arm64 libgl-dev:arm64 libxcursor-dev:arm64 libxrandr-dev:arm64 libxinerama-dev:arm64 libxi-dev:arm64 libxxf86vm-dev:arm64

      - name: Run GoReleaser
        run: goreleaser release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  macos:
    name: Build macOS
    strategy:
      matrix:
        include:
          - goarch: amd64
            runner: macos-13
            arch_label: x86_64
          - goarch: arm64
            runner: macos-latest
            arch_label: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build
        env:
          GOOS: darwin
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: "1"
        run: |
          go build -tags=urfave_cli_no_docs \
            -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }} -X main.commit=${{ github.sha }} -X main.date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            -o tailscale-proxy-app .
          tar czf "tailscale-proxy-app_${{ steps.version.outputs.version }}_macOS_${{ matrix.arch_label }}.tar.gz" tailscale-proxy-app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.goarch }}
          path: "*.tar.gz"

  upload-macos:
    name: Upload macOS to Release
    needs: [release, macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          merge-multiple: true

      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.ref_name }}" *.tar.gz --repo "${{ github.repository }}" --clobber

  homebrew:
    name: Update Homebrew Formula
    needs: [upload-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download macOS artifacts (for checksums)
        uses: actions/download-artifact@v4
        with:
          pattern: macos-*
          merge-multiple: true

      - name: Download Linux amd64 tarball checksum
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release download "${{ github.ref_name }}" \
            --pattern "checksums.txt" \
            --repo "${{ github.repository }}" || true
          gh release download "${{ github.ref_name }}" \
            --pattern "tailscale-proxy-app_${{ steps.version.outputs.version }}_linux_x86_64.tar.gz" \
            --repo "${{ github.repository }}"
          gh release download "${{ github.ref_name }}" \
            --pattern "tailscale-proxy-app_${{ steps.version.outputs.version }}_linux_arm64.tar.gz" \
            --repo "${{ github.repository }}"

      - name: Compute checksums
        id: checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "mac_amd64=$(sha256sum tailscale-proxy-app_${VERSION}_macOS_x86_64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "mac_arm64=$(sha256sum tailscale-proxy-app_${VERSION}_macOS_arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_amd64=$(sha256sum tailscale-proxy-app_${VERSION}_linux_x86_64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$(sha256sum tailscale-proxy-app_${VERSION}_linux_arm64.tar.gz | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Generate Homebrew formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO="e-kotov/tailscale-proxy-app"
          cat > formula.rb << FORMULA
          class TailscaleProxyApp < Formula
            desc "Standalone userspace egress proxy for Tailscale exit nodes (no root required). It exposes a local HTTP/SOCKS5 proxy that routes traffic through any of your tailnet's exit nodes."
            homepage "https://github.com/${REPO}"
            license "BSD-3-Clause"
            version "${VERSION}"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/${REPO}/releases/download/v${VERSION}/tailscale-proxy-app_${VERSION}_macOS_arm64.tar.gz"
                sha256 "${{ steps.checksums.outputs.mac_arm64 }}"
              else
                url "https://github.com/${REPO}/releases/download/v${VERSION}/tailscale-proxy-app_${VERSION}_macOS_x86_64.tar.gz"
                sha256 "${{ steps.checksums.outputs.mac_amd64 }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/${REPO}/releases/download/v${VERSION}/tailscale-proxy-app_${VERSION}_linux_arm64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_arm64 }}"
              else
                url "https://github.com/${REPO}/releases/download/v${VERSION}/tailscale-proxy-app_${VERSION}_linux_x86_64.tar.gz"
                sha256 "${{ steps.checksums.outputs.linux_amd64 }}"
              end
            end

            def install
              bin.install "tailscale-proxy-app"
            end

            test do
              system "#{bin}/tailscale-proxy-app --version"
            end
          end
          FORMULA
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' formula.rb
          cat formula.rb

      - name: Push formula to homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Clone the tap repo, update the formula, push
          git clone "https://x-access-token:${GH_TOKEN}@github.com/e-kotov/homebrew-tap.git" tap
          mkdir -p tap/Formula
          cp formula.rb tap/Formula/tailscale-proxy-app.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/tailscale-proxy-app.rb
          git commit -m "Update tailscale-proxy-app to ${{ steps.version.outputs.version }}" || echo "No changes"
          git push
